---
title: "Making Subgroup Plots with {ggplot2}"
author: "Peter Higgins"
date: "11/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tibble)
library(glue)
library(writexl)
library(grid)
library(gridExtra)
library(scales)
```

## Getting Started with Subgroup Plots

Subgroup plots are a bit of a fetish of medical journals, as a way to rummage through the results, hunting for possible subgroups which might receive more or less benefit than the average participant. 

These subgroup analyses, are of course, underpowered, as you are dividing the sample size of the overall study (in which you can usually barely afford to get 80% power) into multiple (underpowered) subgroup analyses. To make matters worse, you are often (at the request of multiple reviewers and editors), analyzing 15-25 subgroups, resulting in a real problem of multiple comparisons, and occasionally yielding an outlier that looks significantly different from the overall effect, but is probably only so by chance.

Many statisticians have weighed in on what a bad idea this practice is (examples provided [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3068511/), [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC59592/), and [here](https://pubmed.ncbi.nlm.nih.gov/11701102/)). However, they are just **so much fun to look at** that journal editors, particularly in the UK and at the _New England Journal of Medicine_ are very reluctant to give them up.

This has led to some spectacular statistical trolling, most famously in the [ISIS-1 study] published in the Lancet in 1988. The statisticians involved were very resistant

## Just Show Me the Code

Here is code for a subgroup plot for a randomized controlled trial of 100 mg vs. 200 mg indomethacin in the prevention of post-ERCP pancreatitis. 

The full paper, including figure 2 on page 137, which is the resulting plot (with some formatting/UK spellings added by journal staff), can be found at: https://github.com/higgi13425/subgroup_plot/blob/master/lancetgastro_2020_indomethacin.pdf


```{r all-code, eval=FALSE}
#  subgroup diagram for Indomethacin RCT 100 v 200
library(tibble)
library(tidyverse)
library(glue)
library(writexl)
library(gridExtra)

group_subgroup <- c(
  "Age                  ", "45 or under", "Over 45", 
  "Sex                  ", 'Female', 'Male', 
  "Obese                ", "Ob No", "Ob Yes", 
  "Sphincter of Oddi Dysfunction ", "SOD No", "SOD Yes", 
  "Hx PEP                ", "HP No", "HP Yes", 
  "Hx Pancreatitis       ", "Hpan No", "Hpan Yes", 
  "Difficult Cannulation                ", "DC No", "DC Yes", 
  "Precut               ", "Pre No", "Pre Yes", 
  "Sphincterotomy               ", "Sph No", "Sph Yes", 
  "Pancreatography              ", "Panc No", "Panc Yes",
  "Acinarization                ", "Ac No", "Ac Yes", 
  "Biliary Sphincterotomy                ", "BS No", "BS Yes", 
  "Ampullectomy                ", "Amp No", "Amp Yes", 
  "Prophy Pancreatic Stent                ", "PS No", "PS Yes", 
  "Ther Pancreatic Stent                ", "PS No", "PS Yes",   "Trainee                ", "T No", "T Yes", 
  "Double Wire                ", "DW No", "DW Yes", 
  "Aspirin                ", "Asa No", "Asa Yes", 
  "Site                  ", "1", "2", "3", "4","5","6",
  "Overall                ")

risk_diff_pct <- c(NA,3.98,0.56, NA,2.53,2.65, NA, 1.01, 4.47, #obese
                   NA,2.28,2.39, 
                   NA, -0.22,16.87, NA, 1.88,3.04,  NA, 3.27, -0.21, NA, 2.49, 1.81, 
                   NA, 1.25, 3.29, NA,-4.97,3.2, NA, 0.97, 33.55,  NA, 4.48, 0.86, 
                   NA, 2.4, 0.63,   NA, 4.18, 0.83, NA, 2.0,7.65,   NA, 2.93, -2.45, 
                   NA, 2.19, 5.56, NA, 2.82, -0.95, NA, 4.69, -18.43, 0, 1.99, -10.48, -33.33,
                   2.31)

lcb <- c(NA,-3.27,-4.37, NA,-2.36, -4.92, NA, -4.15, -2.57, #obese
         NA,-4.1,-3.07, 
         NA, -4.6,4.71, NA, -3.24,-4,  
         NA, -1.53, -8.52, NA, -1.98, -10.06, NA, -4.13, -3.2, NA,-11.82,-1.52,
         NA, -3.25, 11.03,  NA, -2.27, -4.4,  NA, -1.94, -14.11, 
         NA, -2.35, -4.51, NA,-2.66,-5.6,   NA, -1.49, -14.73,   
         NA, -2.06, -16.97, NA, -1.6, -13.07, NA, -0.42, -41.15, 0, -4.03, -32.04, -86.68,
         -1.87)

ucb <- c(NA, 11.2, 5.49, NA,7.42, 10.22, NA, 6.17, 11.52, #obese
         NA,8.66,7.85, 
         NA, 4.16,29.03, NA, 7,10.09,  
         NA, 8.07, 8.09, NA, 6.95, 13.67, NA, 6.63, 9.78, NA,18.85,7.91,
         NA, 5.18, 56.07,  NA, 11.23, 6.12,  NA, 6.73, 15.36, 
         NA, 10.72, 6.18, NA,6.33,24.11,   NA, 7.35, 9.83,   
         NA, 6.43, 28.08, NA, 7.26, 11.16, NA, 9.81, 4.28, 0, 8, 11.09, 20.01,
         6.48)

number <- c(NA,417,620, NA,813, 224, NA,646,391, #obese
            NA,388,649, 
            NA, 860,177, NA, 625,412, 
            NA, 743,294, NA, 920, 117, NA, 561,476,  NA,158,879,
            NA, 994,43,  NA, 445, 592,  NA, 975, 62, 
            NA, 336, 701, NA, 945,92,   NA, 885,152,  
            NA, 1001, 36, NA, 895,142, NA, 760,48,4,179,41,5,
            1037)



df <- tibble(group_subgroup, lcb, risk_diff_pct, ucb, number)  
df <- df %>%  mutate(num = as.character(1:62))
write_xlsx(df, "indomethacin_ride.xlsx")

g <- ggplot(data = df,
       mapping = aes(x = risk_diff_pct, 
                     y = fct_reorder(num, desc(as.numeric(num))))) +
  geom_point() +
  geom_errorbarh(data= df, aes(x = risk_diff_pct, xmin = lcb,
                 xmax = ucb, 
                 y = fct_reorder(num, desc(as.numeric(num))))) +
  geom_vline(xintercept =0, col= 'black') +
  geom_vline(xintercept =2.31, col= 'red') +
  labs(x ='Percent Risk Difference \n(95% CI)',
    y = "", subtitle = "  N per subgroup             Overall Effect",
    title = "Subgroup Effects on Risk Difference") +
    #caption = "Toward left, indomethacin 100mg better, Toward right, Indomethacin 200mg better        ") +
  theme_minimal() +
  geom_text(data=df, size = 3, aes(x = -90, label = number, 
         y = fct_reorder(num, desc(as.numeric(num))))) +
  scale_x_continuous(limits = c(-90, 60),
        breaks =c(-90,-75,-60,-45,-30,-15,0, 15, 30, 60)) +  
  scale_y_discrete(breaks = 1:62, labels = c(
    "Age                    ",
    "45 or Under",
    "Over 45",
    "Sex                     ",
    "Female",
    "Male",
    "Obese                  ",
    "No",
    "Yes",
    "Sphincter of Oddi Dysfunction ",
    "No",
    "Yes",
    "History of Post-ERCP Pancreatitis  ",
    "No",
    "Yes",
    "History of Recurrent Pancreatitis       ",
    "No",
    "Yes",
    "Difficult Cannulation ",
    "No",
    "Yes",
    "Precut Sphincterotomy  ",
    "No",
    "Yes",
    "Pancreatic Sphincterotomy ",
    "No",
    "Yes",
    "Pancreatography ",
    "No",
    "Yes",   
    "Acinarization         ",
    "No",
    "Yes",
    "Biliary Sphincterotomy",
    "No",
    "Yes",
    "Ampullectomy         ",
    "No",
    "Yes",
    "Prophylactic Pancreatic Stent placement ",
    "No",
    "Yes",
    "Therapeutic Pancreatic Stent placement ",
    "No",
    "Yes",
    "Trainee Involvement ",
    "No",
    "Yes",
    "Double Wire technique",
    "No",
    "Yes",
    "Aspirin use          ",
    "No",
    "Yes",
    "Study Site          ",
    "1","2", "3","4","5","6",
    "Overall              "
  )) +
# annotate("text", label = "Overall Effect", x=1, y=64, col='red') +
  annotate("text", label = "Favors 100 mg", x=-45, y=59.5, col='black') +
  annotate("text", label = "Favors 200 mg", x=45, y=59.5, col='black') +
  geom_segment(aes(x=-30, xend=-60, y = 58, yend=58),
               linejoin = "mitre",
               colour = "black",
               arrow= arrow(length = unit(0.1, "cm"),type = "closed")
               ) +
  geom_segment(aes(x=30, xend=60, y = 58, yend=58),
               linejoin = "mitre",
               colour = "black",
               arrow= arrow(length = unit(0.1, "cm"),type = "closed")
  ) 
g2 <- g + theme(plot.margin = margin(t=1.5,r=0.5,b=0.5,l =0.5, unit = "cm"))
g2 <- g2 + theme(panel.grid.major = element_blank())
g2 <- g2 + theme(axis.line = element_line(color = "black"))
g2


#now turn off panel clipping
# from blog post at
# https://rud.is/b/2015/08/27/coloring-and-drawing-outside-the-lines-in-ggplot/
library(grid)
library(gridExtra)
library(scales)
gb <- ggplot_build(g2)
gt <- ggplot_gtable(gb)

gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)

## Now to save - different formats

# ggsave("subgroup_plot.jpeg", width = 6.5, height = 9, units = "in", dpi = 320)

# ggsave("subgroup_plot.tiff", width = 6.5, height = 9,  units = "in", dpi = 320)

# ggsave("subgroup_plot.pdf", width = 6.5, height = 9,  units = "in", dpi = 320)

```

